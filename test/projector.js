function Projector(t,e){this.elements={el:t,container:null,canvas:null,loading:null,link:null,rewind:null,pause:null,play:null},this.state={audio:!1,locked:!1,movie:!1,muted:!1,quality:0,started:!1,playing:!0,tickTimeout:null,frame:0,width:0,height:0,loadTimes:[]},this.settings={autoplay:!0,frameRate:24,columns:10,rows:10,loop:!0,controls:!0,eventPixel:"",events:[],lookAhead:3,movieUrl:"",clickUrl:"",clickThroughUrl:"",quality:3,qualities:["10x100","25x100","50x100","75x100"],dynamicQuality:!0,maxQuality:4,facebookUrl:"",youtubeUrl:""},this.settings=Projector.extend(e,this.settings),this.settings.totalFrames--,this.collection=[]}Projector.prototype.init=function(){this.state.width=this.elements.el.offsetWidth,this.state.height=this.elements.el.offsetHeight,this.checkIframeSettings(),this.make(),this.resize(),this.bindEvents(),this.settings.autoplay&&this.startMovie()},Projector.prototype.checkIframeSettings=function(){var t=Projector.getParam("clickUrl"),e=Projector.getParam("clickThroughUrl");t&&(this.settings.clickUrl=t),e&&(this.settings.clickThroughUrl=e)},Projector.prototype.make=function(){this.state.framesPerSlide=this.settings.columns*this.settings.rows,this.state.timePerSlide=this.settings.columns*this.settings.rows/this.settings.frameRate*1e3,this.state.totalImages=Math.ceil(this.settings.totalFrames/this.state.framesPerSlide),this.state.quality=this.settings.quality;for(var t=0;t<this.state.totalImages;t++)this.collection.push({status:"pristine"});var e=['<div class="container" style="width: 100%; height: 100%;">','<canvas class="canvas" width="{width}" height="{height}" style="width: {width}px; height: {height}px;"></canvas>','<a href="{clickThroughUrl}" target="_blank" class="link"></a>','<div class="loading"></div>','<div class="controls">','<a class="rewind"></a>','<a class="pause"></a>','<a class="play"></a>','<a class="mute mute-off"></a>','<div class="equalizer">','<div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>',"</div>",'<a href="{movieUrl}" class="fullscreen" target="_blank"></a>',"</div>",'<div class="socials">','<a href="{youtubeUrl}" class="social youtube" target="_blank"></a>','<a href="{facebookUrl}" class="social facebook" target="_blank"></a>',"</div>","</div>"];e=e.join("");for(var s=["clickThroughUrl","movieUrl","youtubeUrl","facebookUrl"],t=0;t<s.length;t++){var i=new RegExp("{"+s[t]+"}","g");e=e.replace(i,this.settings[s[t]])}e=e.replace(/{width}/g,this.state.width),e=e.replace(/{height}/g,this.state.height),this.elements.el.innerHTML=e;for(var a=["canvas","container","controls","equalizer","fullscreen","loading","link","mute","movie","rewind","pause","play"],t=0;t<a.length;t++){var o=a[t];this.elements[o]=this.elements.el.querySelector("."+o)}this.state.ctx=this.elements.canvas.getContext("2d"),this.settings.controls||(this.elements.controls.style.display="none"),this.settings.movieUrl||(this.elements.fullscreen.style.display="none"),this.elements.audio=new Audio,this.elements.audio.muted=this.state.muted,this.elements.audio.src=this.settings.audioUrl,this.elements.audio.preload=!0},Projector.prototype.bindEvents=function(){var t=this;this.elements.play&&(this.elements.play.onclick=function(){t.play.call(t,!0)}),this.elements.pause&&(this.elements.pause.onclick=function(){t.state.playing?t.pause.call(t,!0):t.play.call(t,!0)}),this.elements.rewind&&(this.elements.rewind.onclick=function(){t.rewind.call(t,!0)}),this.elements.mute&&(this.elements.mute.onclick=function(){t.mute.call(t)}),this.elements.link&&(this.elements.link.onclick=function(e){t.handleClick.call(t,e)}),this.elements.equalizer&&(this.elements.equalizer.onclick=function(e){t.handleEqualizerClick.call(t,e)}),window.addEventListener("message",function(e){t.handleMessage.call(t,e)},!1),window.addEventListener("focus",function(){t.play.call(t)}),window.addEventListener("blur",function(){t.pause.call(t)})},Projector.prototype.play=function(t){(!this.state.locked||t)&&("undefined"!=typeof t&&(this.state.locked=!t),this.state.started?(this.state.playing=!0,Projector.addClass(this.elements.container,"playing"),Projector.removeClass(this.elements.container,"paused"),clearTimeout(this.state.tickTimeout),this.tick(this.state.frame),this.state.audio&&this.elements.audio.play()):this.startMovie())},Projector.prototype.pause=function(t){this.state.playing=!1,t&&(this.state.locked=!0),Projector.addClass(this.elements.container,"paused"),Projector.removeClass(this.elements.container,"playing"),this.state.tickTimeout=clearTimeout(this.state.tickTimeout),this.state.audio&&this.elements.audio.pause()},Projector.prototype.rewind=function(t){this.startMovie(),t&&this.play(t),this.state.frame=0,this.synchAudio(0,!0)},Projector.prototype.mute=function(){this.state.muted=!this.state.muted,(this.state.movie||this.state.audio)&&(this.elements.audio.muted=this.state.muted,this.elements.mute.style.backgroundImage=this.state.muted?"url(images/mute-on.png)":"url(images/mute-off.png)",Projector.toggleClass(this.elements.mute,"mute-on",this.state.muted),Projector.toggleClass(this.elements.mute,"mute-off",!this.state.muted))},Projector.prototype.startMovie=function(){var t=this;this.state.started=!0,this.state.frame=0,this.showLoading(),this.state.loadTimes=[],this.state.tickTimeout&&clearTimeout(this.state.tickTimeout);for(var e=0;e<this.collection.length;e++)this.collection[e].status="pristine";this.loadImage(0,function(){t.play.call(t)})},Projector.prototype.handleMessage=function(t){switch(t.data){case"pause":this.pause();break;case"play":this.play();break;case"resize":this.resize()}},Projector.prototype.handleClick=function(){if(this.settings.clickUrl){var t=new Image;t.src=this.settings.clickUrl}},Projector.prototype.handleEqualizerClick=function(t){t.preventDefault(),Projector.isMobileSafari()?this.playRealMovie():this.playAudio(!0)},Projector.prototype.resize=function(){this.state.width=this.elements.el.offsetWidth,this.state.height=this.elements.el.offsetHeight,this.elements.canvas&&(this.elements.canvas.width=this.state.width,this.elements.canvas.height=this.state.height,this.elements.canvas.style.width=this.state.width+"px",this.elements.canvas.style.height=this.state.height+"px",this.state.ctx.clearRect(0,0,this.state.width,this.state.height))},Projector.prototype.playRealMovie=function(){window.open(this.settings.movieUrl)},Projector.prototype.playAudio=function(){var t=this;this.elements.audio.play(),4==this.elements.audio.readyState?(this.synchAudio(this.state.frame,!0),this.elements.mute.style.display="block",this.elements.equalizer.style.display="none",this.state.audio=!0):this.elements.audio.addEventListener("canplaythrough",function(){t.playAudio.call(t)})},Projector.prototype.loadImage=function(t,e){var s=this,i=this.collection[t];if(i&&"pristine"==i.status){i.status="loading",this.settings.dynamicQuality&&this.doQualityCheck();var a=this.settings.imageFiles;a=a.replace("%q",this.settings.qualities[this.state.quality]),a=a.replace("%i",t),a=a+"?ord="+Math.random().toString().substr(2),i.src=a;var o=(new Date).valueOf(),n=new Image;n.src=a,i.image=n,n.onload=function(){s.state.loadTimes.push((new Date).valueOf()-o),i.status="ready",e&&e()}}else i&&"ready"==i.status&&e&&e()},Projector.prototype.drawImage=function(t,e){var s=e%this.state.framesPerSlide,i=Math.floor(s/this.settings.columns),a=s%this.settings.columns,o=this.getIndex(e),t=this.getImage(o).image,n=t.width/this.settings.columns,l=t.height/this.settings.rows,r=l/n,h=this.state.width,c=this.state.width*r,u=(this.state.height-c)/2;this.state.ctx.drawImage(t,a*n,i*l,n,l,0,u,h,c)},Projector.prototype.getIndex=function(t){return Math.floor(t/this.state.framesPerSlide)},Projector.prototype.getImage=function(t){return t>=this.collection.length?null:this.collection[t]},Projector.prototype.getCompletionPercentage=function(t){return t/this.settings.totalFrames*100},Projector.prototype.getLoadTimePercentage=function(){if(!this.state.loadTimes.length)return 0/0;var t=this.state.loadTimes.slice(-1)[0],e=t/this.state.timePerSlide*100;return e},Projector.prototype.tick=function(t){t=t||0;var e=this;return this.settings.loop&&t>this.settings.totalFrames?this.startMovie():void(this.state.tickTimeout=setTimeout(function(){var s=e.getIndex.call(e,t),i=e.getImage.call(e,s);switch(i.status){case"ready":e.hideLoading.call(e),e.state.audio&&e.elements.audio.paused&&e.elements.audio.play(),e.renderFrame.call(e,t),t++,e.tick.call(e,t);break;case"pristine":case"loading":e.showLoading.call(e),e.state.audio&&!e.elements.audio.paused&&e.elements.audio.pause(),e.tick.call(e,t)}},1e3/this.settings.frameRate))},Projector.prototype.renderFrame=function(t){var e=this.getImage(this.getIndex(t));this.drawImage(e.src,t),this.doPixelTracking(t),this.doLookAhead(t),this.state.audio&&this.elements.audio.paused&&this.elements.audio.play(),this.state.audio&&t%this.settings.frameRate==0&&this.synchAudio(t,!1),this.state.frame=t},Projector.prototype.doPixelTracking=function(t){for(var e=this.getCompletionPercentage(t),s=0;s<this.settings.events.length;s++)if(e>=this.settings.events[s].mark&&!this.settings.events[s].src){this.settings.events[s].src=this.settings.eventSrc.replace(":mark",this.settings.events[s].name);var i=new Image;i.src=this.settings.events[s].src}},Projector.prototype.doLookAhead=function(t){for(var e=this.getIndex(t)+1,s=0;3>s;s++){var i=this.getImage(e+s);if(i&&"pristine"==i.status){this.loadImage(e+s);break}}},Projector.prototype.doQualityCheck=function(){var t=this.getLoadTimePercentage();50>=t&&this.state.quality<this.settings.qualities.length-1&&this.state.quality++,t>100&&this.state.quality>0&&this.state.quality--,t>150&&this.state.quality>0&&this.state.quality--,t>200&&this.state.quality>0&&this.state.quality--,this.state.quality>this.settings.maxQuality&&(this.state.quality=this.settings.maxQuality)},Projector.prototype.synchAudio=function(t,e){e&&(this.elements.audio.currentTime=t/this.settings.frameRate);var s=this.elements.audio.currentTime*this.settings.frameRate;this.elements.audio.playbackRate=s>t?.97:t>s?1.03:1},Projector.prototype.showLoading=function(){if(!this.state.loadingInterval){var t=this,e=0;this.elements.loading.style.display="block",this.state.loadingInterval=setInterval(function(){var s=19,i=38,a=e*-i;t.elements.loading.style.backgroundPosition="0px "+a+"px",e++,e>=s&&(e=0)},50)}},Projector.prototype.hideLoading=function(){this.state.loadingInterval&&(clearInterval(this.state.loadingInterval),this.state.loadingInterval=null,this.elements.loading.style.display="none")},Projector.extend=function(t,e){var s;for(s in e)if(e.hasOwnProperty(s))if("object"==typeof e[s])t[s]=Projector.extend(t[s]||(e[s]instanceof Array?[]:{}),e[s]);else{if(void 0!=t[s])continue;t[s]=e[s]}return t},Projector.addClass=function(t,e){t.className.indexOf(e)<0&&(t.className=e+" "+t.className)},Projector.removeClass=function(t,e){t.className=t.className.replace(e+" ","")},Projector.toggleClass=function(t,e,s){s?Projector.addClass(t,e):Projector.removeClass(t,e)},Projector.isMobileSafari=function(){var t=/(iPhone|iPod|iPad)/g.test(navigator.userAgent);return t},Projector.getParam=function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),s=e.exec(location.search);return null==s?"":decodeURIComponent(s[1].replace(/\+/g," "))};